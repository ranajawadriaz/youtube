# Fix YouTube Bot Detection on Digital Ocean (Cloud Servers)

## Problem
YouTube blocks requests from cloud server IPs (Digital Ocean, AWS, Azure, etc.) with errors like:
```
Sign in to confirm you're not a bot
YouTube is blocking requests from your IP
```

## Solution: Use Browser Cookies (100% Free)

This authenticates your requests as a legitimate user without proxies or paid services.

---

## Step 1: Export YouTube Cookies from Your Browser

### Method A: Using Browser Extension (Easiest)

#### For Chrome/Edge:
1. Install extension: **"Get cookies.txt LOCALLY"**
   - Chrome: https://chrome.google.com/webstore/detail/get-cookiestxt-locally/cclelndahbckbenkjhflpdbgdldlbecc
   - Edge: Search in Edge Add-ons store

2. **Go to YouTube.com and make sure you're logged in**

3. Click the extension icon

4. Click **"Export"** or **"Download"**

5. Save as `cookies.txt`

#### For Firefox:
1. Install extension: **"cookies.txt"**
   - Firefox: https://addons.mozilla.org/en-US/firefox/addon/cookies-txt/

2. **Go to YouTube.com and make sure you're logged in**

3. Click the extension icon

4. Click **"Current Site"**

5. Save as `cookies.txt`

### Method B: Using yt-dlp (Alternative)

If you have yt-dlp installed locally:

```bash
# Export cookies from Chrome
yt-dlp --cookies-from-browser chrome --cookies cookies.txt https://www.youtube.com/

# Export cookies from Firefox
yt-dlp --cookies-from-browser firefox --cookies cookies.txt https://www.youtube.com/

# Export cookies from Edge
yt-dlp --cookies-from-browser edge --cookies cookies.txt https://www.youtube.com/
```

---

## Step 2: Upload Cookies to Your Digital Ocean Server

### Option A: Using SCP (from your local machine)

```bash
# Replace YOUR_DROPLET_IP with your actual IP
scp cookies.txt root@YOUR_DROPLET_IP:/root/

# If you deployed in a specific directory
scp cookies.txt root@YOUR_DROPLET_IP:/opt/youtube-transcript-api/
```

### Option B: Using SFTP

1. Connect with FileZilla or WinSCP
2. Navigate to `/root/` or your project directory
3. Upload `cookies.txt`

### Option C: Manual Copy-Paste

```bash
# SSH into your server
ssh root@YOUR_DROPLET_IP

# Create the cookies file
nano /root/cookies.txt

# Paste the entire content of your cookies.txt
# Press Ctrl+X, then Y, then Enter to save
```

---

## Step 3: Verify File Permissions

```bash
# SSH into your server
ssh root@YOUR_DROPLET_IP

# Check if file exists
ls -la /root/cookies.txt

# Set proper permissions
chmod 600 /root/cookies.txt

# Verify content (should show cookies)
head -5 /root/cookies.txt
```

Expected output should look like:
```
# Netscape HTTP Cookie File
# This file is generated by yt-dlp.  Do not edit.

.youtube.com	TRUE	/	TRUE	1234567890	CONSENT	YES+...
.youtube.com	TRUE	/	FALSE	1234567890	VISITOR_INFO1_LIVE	...
```

---

## Step 4: Restart Your FastAPI Service

```bash
# If using PM2
pm2 restart fastapi-app

# If using systemd
sudo systemctl restart youtube-transcript-api

# Check logs to verify cookies are being used
pm2 logs fastapi-app --lines 20
# Look for: "Using cookies from: /root/cookies.txt"
```

---

## Step 5: Test the API

```bash
# Health check
curl http://localhost:8000/

# Test with a YouTube video
curl -X POST "http://localhost:8000/generate" \
  -H "Content-Type: application/json" \
  -d '{
    "youtube_url": "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
    "prompt": "Create a simple summary with exactly 1 image"
  }' \
  --output result.zip

# Check if successful (should be a ZIP file)
file result.zip
unzip -l result.zip
```

---

## Alternative Solutions (If Cookies Don't Work)

### Option 1: Use Free Proxy Rotation

Install free proxy support:

```bash
pip install requests[socks]
```

Add to `enhanced_config.py`:
```python
# Free proxy list (rotate these)
PROXIES = [
    "socks5://free-proxy1.com:1080",
    "socks5://free-proxy2.com:1080",
]
```

**Note:** Free proxies are unreliable and slow.

### Option 2: Use IPv6 (If Available)

Digital Ocean droplets can get IPv6 for free:

1. Enable IPv6 in Digital Ocean control panel
2. Configure your droplet to use IPv6
3. YouTube may not block IPv6 addresses

### Option 3: Use YouTube Official API (Limited Free Tier)

- 10,000 units/day free quota
- Only works for videos with captions
- Requires Google Cloud account

---

## Troubleshooting

### Issue: Cookies file not found
```bash
# Check file location
find /root -name "cookies.txt"
find /opt -name "cookies.txt"

# Update config if in different location
nano /opt/youtube-transcript-api/enhanced_config.py
# Change: COOKIES_FILE = "/full/path/to/cookies.txt"
```

### Issue: Still getting bot detection error
1. **Refresh your cookies** - Export new ones from browser
2. **Make sure you're logged into YouTube** when exporting
3. **Wait 10-15 minutes** - YouTube may have temporarily blocked your IP
4. **Try a different Google account** - Some accounts may be flagged

### Issue: Cookies expired
Cookies typically expire after 30-90 days. Re-export and re-upload.

```bash
# Check cookie expiration dates
cat /root/cookies.txt | grep -v "^#" | awk '{print $5}' | sort -u
```

### Issue: Permission denied
```bash
# Fix permissions
sudo chown www-data:www-data /root/cookies.txt
sudo chmod 600 /root/cookies.txt

# If service runs as root
sudo chown root:root /root/cookies.txt
sudo chmod 600 /root/cookies.txt
```

---

## Security Best Practices

1. **Never share your cookies file** - It contains authentication tokens
2. **Set restrictive permissions**: `chmod 600 cookies.txt`
3. **Don't commit to Git** - Already in `.gitignore`
4. **Rotate cookies monthly** - Export fresh ones regularly
5. **Use a dedicated YouTube account** - Don't use your main Google account

---

## How It Works

1. Browser cookies contain authentication tokens from YouTube
2. yt-dlp uses these cookies to authenticate requests
3. YouTube sees requests as coming from a logged-in user
4. Bot detection is bypassed âœ…

---

## Cookie File Format (Netscape Format)

Your `cookies.txt` should look like this:

```
# Netscape HTTP Cookie File
# This is a generated file! Do not edit.

.youtube.com	TRUE	/	FALSE	0	PREF	...
.youtube.com	TRUE	/	TRUE	0	CONSENT	...
.youtube.com	TRUE	/	FALSE	0	VISITOR_INFO1_LIVE	...
.youtube.com	TRUE	/	FALSE	0	YSC	...
```

If your file doesn't start with `# Netscape HTTP Cookie File`, it's in the wrong format!

---

## Success Indicators

When working correctly, your logs should show:

```
2025-10-19 08:00:00,000 - INFO - Using cookies from: /root/cookies.txt
2025-10-19 08:00:00,500 - INFO - Fetching video metadata...
2025-10-19 08:00:01,200 - INFO - Metadata fetched: Video Title Here
2025-10-19 08:00:01,300 - INFO - Attempting to extract transcript for video ID: ...
2025-10-19 08:00:02,100 - INFO - Transcript extracted successfully: youtube_transcript
```

**No more bot detection errors!** ðŸŽ‰

---

## Need Help?

If you're still experiencing issues:

1. Check PM2 logs: `pm2 logs fastapi-app --lines 50`
2. Check system logs: `sudo journalctl -u youtube-transcript-api -n 50`
3. Verify cookies are valid: Try the same video in your browser
4. Test with different videos: Some may be geo-restricted

---

## Maintenance Schedule

- **Weekly**: Check if service is still working
- **Monthly**: Re-export and upload fresh cookies
- **After errors**: Export new cookies and restart service

This solution is **100% free** and works reliably! ðŸš€
